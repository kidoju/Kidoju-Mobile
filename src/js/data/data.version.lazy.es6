/**
 * Copyright (c) 2013-2021 Memba Sarl. All rights reserved.
 * Sources at https://github.com/Memba
 */

// https://github.com/benmosher/eslint-plugin-import/issues/1097
// eslint-disable-next-line import/extensions, import/no-extraneous-dependencies, import/no-unresolved
import $ from 'jquery';
import 'kendo.data';
import db from '../app/app.db.es6';
import __ from '../app/app.i18n.es6';
import { getSummaryReference } from '../app/app.partitions.es6';
import themer from '../app/app.themer.es6'; // TODO
import { editorUri, playerUri } from '../app/app.uris.es6';
import CONSTANTS from '../common/window.constants.es6';
import AjaxVersions from '../rapi/rapi.versions.es6';
import BaseModel from './data.base.es6';
import { isMobileApp, normalizeSchema } from './data.util.es6';
import extendModelWithTransport from './mixins.transport.es6';
import LocalTransport from './transports.local.es6';
import LazyRemoteTransport from './transports.remote.lazy.es6';
import DownstreamStrategy from './strategy.downstream.es6';

const {
    data: { DataSource },
    format,
} = window.kendo;

/**
 * Lazy version
 * @class LazyVersion
 * @extends BaseModel
 */
const LazyVersion = BaseModel.define({
    id: CONSTANTS.ID, // the identifier of the model, which is required for isNew() to work
    fields: {
        id: {
            type: CONSTANTS.STRING,
            editable: false,
            nullable: true,
        },
        // created
        // language
        name: {
            from: CONSTANTS.EMPTY, // Do not include in projection
            type: CONSTANTS.STRING,
            editable: false,
        },
        state: {
            type: CONSTANTS.NUMBER,
            editable: false,
        },
        // stream
        summaryId: {
            type: CONSTANTS.STRING,
            editable: false,
            nullable: true,
        },
        // type
        // updated
        // userId
    },
    playerUri$() {
        return playerUri(__.locale, this.get('summaryId'), this.get('id'));
    },
    editorUri$() {
        return editorUri(__.locale, this.get('summaryId'));
    },
    iframe$() {
        // TODO consider the sandbox attribute -- see http://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/
        return format(
            '<iframe src="{0}?embed=true{1}" style="height:500px;width:100%;border:solid 1px #d5d5d5;"></iframe>',
            this.playerUri$(),
            themer && $.isFunction(themer.name)
                ? `&theme=${encodeURIComponent(themer.name())}`
                : ''
        );
    },
});

/**
 * localTransport
 */
const localTransport = new LocalTransport({
    collection: db.versions,
    partition: getSummaryReference(),
    projection: BaseModel.projection(LazyVersion),
});

/**
 * remoteTransport
 */
const remoteTransport = new LazyRemoteTransport({
    collection: new AjaxVersions({
        partition: getSummaryReference(),
        projection: BaseModel.projection(LazyVersion),
    }),
});

/**
 * transport
 */
/* eslint-disable prettier/prettier */
const transport = isMobileApp()
    ? new DownstreamStrategy({
        localTransport,
        remoteTransport,
    })
    : remoteTransport;
/* eslint-enable prettier/prettier */

/**
 * Extend LazyVersion with transport
 */
extendModelWithTransport(LazyVersion, transport);

/**
 * LazyVersionDataSource
 * @class LazyVersionDataSource
 * @extends DataSource
 */
const LazyVersionDataSource = DataSource.extend({
    /**
     * Init
     * @constructor
     * @param options
     */
    init(options = {}) {
        DataSource.fn.init.call(
            this,
            $.extend(
                true,
                {
                    pageSize: CONSTANTS.DATA_PAGE_SIZE.MAX,
                },
                options,
                {
                    transport,
                    schema: normalizeSchema({
                        modelBase: LazyVersion,
                        model: LazyVersion,
                        parse(response) {
                            // Name versions: draft, version 1, version 2, ....
                            // TODO Add a sort order to only get the last 100 in case there are more...
                            if (
                                response &&
                                $.type(response.total) === CONSTANTS.NUMBER &&
                                $.isArray(response.data)
                            ) {
                                response.data.forEach((item, index) => {
                                    /* eslint-disable prettier/prettier */
                                    // eslint-disable-next-line no-param-reassign
                                    item.name =
                                        item.state === CONSTANTS.WORKFLOW.DRAFT
                                            ? __('webapp.versions.draft.name')
                                            : format(
                                                __('webapp.versions.published.name'),
                                                response.data.length - index
                                            );
                                    /* eslint-enable prettier/prettier */
                                });
                            }
                            return response;
                        },
                    }),
                    serverFiltering: true,
                    serverSorting: true,
                    serverPaging: true,
                }
            )
        );
    },
});

/**
 * Export
 */
export { LazyVersion, LazyVersionDataSource };
